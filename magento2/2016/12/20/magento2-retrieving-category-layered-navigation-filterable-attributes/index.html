<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Magento 2. Retrieving category layered navigation filterable attributes</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Retrieving layered navigation attributes is a useful task that can be required during optimization and implementaion of various features ...">
    <meta name="robots" content="all">
    <meta name="author" content="Sergii Ivashchenko">
    
    <meta name="keywords" content="magento2">
    <link rel="canonical" href="http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for sivaschenko" href="/feed.xml" />
    <link rel="stylesheet" href="/css/style.css?201612201606" type="text/css">
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.rawgit.com/IonicaBizau/github-calendar/gh-pages/dist/github-calendar.css"/>
    
    
    
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Magento 2. Retrieving category layered navigation filterable attributes">
    <meta property="og:description" content="Written with â™¥ for developers">
    <meta property="og:url" content="http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/">
    <meta property="og:site_name" content="sivaschenko">
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@sergeivaschenko" />
    <meta name="twitter:title" content="Magento 2. Retrieving category layered navigation filterable attributes" />
    <meta name="twitter:description" content="Retrieving layered navigation attributes is a useful task that can be required during optimization and implementaion of various features ..." />
    <meta name="twitter:url" content="http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/" />
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/icons/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/icons/favicon-32x32.png" sizes="32x32">
    
        <script type="text/javascript">
           (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
           (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
           })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
           ga('create', 'UA-33180732-4', 'auto');
           ga('send', 'pageview');
        </script>
    
</head>

<body class="site">
  
	
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://www.sivaschenko.com" class="site-title">sivaschenko</a>
      <nav class="site-nav"><a href="http://www.sivaschenko.com">Posts</a><a href="/about/">About</a><a href="/projects/">Projects</a>
</nav>
      <div class="clearfix"></div><div class="social-icons">
  <div class="social-icons-left">
    <a class="fa fa-github" href="https://github.com/sivaschenko"></a>
    
    
    <a class="fa fa-twitter" href="https://twitter.com/sergeivaschenko"></a>
    
    
    
    
    
    
    <a class="fa fa-envelope" href="mailto:contact@sivaschenko.com"></a>
    <a class="fa fa-rss" href="/feed.xml"></a>
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>
</div>
  </div>
</header>

    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        

<div class="post-header mb2">
  <h1 class="page-title">Magento 2. Retrieving category layered navigation filterable attributes</h1>
  <span class="post-meta">Dec 20, 2016</span><br>
  
  <span class="post-meta small">
  2 minute read
  </span>
</div>
<article class="post-content">
  <h1 id="introduction">Introduction</h1>

<p>Retrieving layered navigation attributes is a useful task that can be required during optimization and implementaion of various features.</p>

<p>As usual, there is more than one way for achieving the goal.</p>

<p>I will start from the most primitive and fast approach, and continue with more framework utilization recommended for future maintainability.</p>

<h1 id="sql-query">SQL Query</h1>

<p>Basically the raw sql query will clearly describe what I am going to achieve:</p>

<p>Variant 1 (subselects):</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
<span class="k">FROM</span> <span class="n">eav_attribute</span>
<span class="k">WHERE</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="k">IN</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
  <span class="k">FROM</span> <span class="n">catalog_eav_attribute</span>
  <span class="k">WHERE</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">is_filterable</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>
<span class="k">AND</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="k">IN</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
  <span class="k">FROM</span> <span class="n">eav_entity_attribute</span>
    <span class="k">JOIN</span> <span class="n">catalog_product_entity</span> <span class="k">ON</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_set_id</span> <span class="o">=</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">attribute_set_id</span>
    <span class="k">JOIN</span> <span class="n">catalog_category_product</span> <span class="k">ON</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">entity_id</span> <span class="o">=</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">product_id</span>
  <span class="k">WHERE</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="p">);</span>
</code></pre>
</div>

<p>Variant 2 (joins):</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span>
  <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
<span class="k">FROM</span> <span class="n">eav_attribute</span>
  <span class="k">JOIN</span> <span class="n">eav_entity_attribute</span> <span class="k">ON</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="o">=</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
  <span class="k">JOIN</span> <span class="n">catalog_eav_attribute</span> <span class="k">ON</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="o">=</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
                             <span class="k">AND</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">is_filterable</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">JOIN</span> <span class="n">catalog_product_entity</span> <span class="k">ON</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_set_id</span> <span class="o">=</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">attribute_set_id</span>
  <span class="k">JOIN</span> <span class="n">catalog_category_product</span> <span class="k">ON</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">entity_id</span> <span class="o">=</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">product_id</span>
                                <span class="k">AND</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span><span class="p">;</span>
</code></pre>
</div>

<p>As you can see the attributes we need are <strong>filterable attributes from attribute sets of products included in specified category</strong>.</p>

<p>These sql queries will also help to test program realization later.</p>

<h1 id="using-resource">Using Resource</h1>

<p>Lets first try to perform the straight query using just a <code class="highlighter-rouge">ResourceConnection</code> (this approach can be used for prototyping or quick debug).</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$categoryId</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>

<span class="sd">/** @var \Magento\Framework\App\ResourceConnection $resource */</span>
<span class="nv">$resource</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Framework\App\ResourceConnection</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$resource</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">();</span>

<span class="nv">$select</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">from</span><span class="p">([</span><span class="s1">'ea'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'eav_attribute'</span><span class="p">)],</span> <span class="s1">'ea.attribute_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'eea'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'eav_entity_attribute'</span><span class="p">)],</span> <span class="s1">'ea.attribute_id = eea.attribute_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'cea'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'catalog_eav_attribute'</span><span class="p">)],</span> <span class="s1">'ea.attribute_id = cea.attribute_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'cpe'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'catalog_product_entity'</span><span class="p">)],</span> <span class="s1">'eea.attribute_set_id = cpe.attribute_set_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'ccp'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'catalog_category_product'</span><span class="p">)],</span> <span class="s1">'cpe.entity_id = ccp.product_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'cea.is_filterable = ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'ccp.category_id = ?'</span><span class="p">,</span> <span class="nv">$categoryId</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="s1">'ea.attribute_id'</span><span class="p">);</span>

<span class="nv">$attributeIds</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">fetchCol</span><span class="p">(</span><span class="nv">$select</span><span class="p">);</span>
</code></pre>
</div>

<p>After this code is executed, <code class="highlighter-rouge">$attributeIds</code> is an array of filtable attribute ids involved in category with specified id.</p>

<p>However this implementation is not ideal, because it skips potentially extended behavior of layered navigation and small details like disabled, out of stock products, etc.</p>

<h1 id="using-layer">Using Layer</h1>

<p>After a bit of investigation I was not able to find framework api to provide filterable attributes for specific category.</p>

<p>So, the task is a bit more complex than seems to be.</p>

<p>Basically all filterable attributes in Magento 2 can be retrived from <strong>FilterableAttributeList</strong>:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$filterableAttributes</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Layer\Category\FilterableAttributeList</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$attributes</span> <span class="o">=</span> <span class="nv">$filterableAttributes</span><span class="o">-&gt;</span><span class="na">getList</span><span class="p">();</span>
</code></pre>
</div>

<p>Retrieving filters involved in layered navigation is a bit more tricky.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$filterableAttributes</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Layer\Category\FilterableAttributeList</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="nv">$appState</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Framework\App\State</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$layerResolver</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Layer\Resolver</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$filterList</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span>
    <span class="nx">\Magento\Catalog\Model\Layer\FilterList</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="s1">'filterableAttributes'</span> <span class="o">=&gt;</span> <span class="nv">$filterableAttributes</span>
    <span class="p">]</span>
<span class="p">);</span>

 <span class="nv">$category</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>
 
 <span class="nv">$appState</span><span class="o">-&gt;</span><span class="na">setAreaCode</span><span class="p">(</span><span class="s1">'frontend'</span><span class="p">);</span>
 <span class="nv">$layer</span> <span class="o">=</span> <span class="nv">$layerResolver</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
 <span class="nv">$layer</span><span class="o">-&gt;</span><span class="na">setCurrentCategory</span><span class="p">(</span><span class="nv">$category</span><span class="p">);</span>
 <span class="nv">$filters</span> <span class="o">=</span> <span class="nv">$filterList</span><span class="o">-&gt;</span><span class="na">getFilters</span><span class="p">(</span><span class="nv">$layer</span><span class="p">);</span>
</code></pre>
</div>

<p>Please be aware, that I am using object manager static calls just for short and explicit example. In clean implementation it is highly recommended to use di instead.</p>

<p>You might also want to use di configuration for defining <code class="highlighter-rouge">filterableAttributes</code> argument.</p>

<p>However this is not the final result. To be sure that filters are actual, it is required to check number of items for each filters. (that check is accually performed during core layered navigation <a href="//github.com/magento/magento2/blob/develop/app/code/Magento/LayeredNavigation/view/frontend/templates/layer/view.phtml#L38">rendering</a>)</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$filters</span> <span class="k">as</span> <span class="nv">$filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$filter</span><span class="o">-&gt;</span><span class="na">getItemsCount</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$filters</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$filter</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In above code block you can also perform additional checks and i.e. throw away Price and Category filter instances, if you need just Attribute type filters.</p>


</article>
<div class="share-page">
  Share this post!
  <div class="share-links">
    
    <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Magento 2. Retrieving category layered navigation filterable attributes&url=http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    
    <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/&title=Magento 2. Retrieving category layered navigation filterable attributes" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    
    
    <a class="fa fa-reddit" href="http://reddit.com/submit?url=http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/&title=Magento 2. Retrieving category layered navigation filterable attributes" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    <a class="fa fa-stumbleupon" href="http://www.stumbleupon.com/submit?url=http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/&title=Magento 2. Retrieving category layered navigation filterable attributes" rel="nofollow" target="_blank" title="Share on StumbleUpon"></a>
    
  </div>
</div>

<div class="post-footer">
  <p>Written with â™¥ by Sergii Ivashchenko.</p>
  <p>Follow him on <a href="https://twitter.com/sergeivaschenko">Twitter</a>.</p>
</div>


  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'sivaschenko';
    var disqus_identifier = '/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes';
    var disqus_title      = "Magento 2. Retrieving category layered navigation filterable attributes";

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




      </div>
    </div>
  </div>
  <footer class="center"><div class="measure"><small>&copy; 2016 Sergii Ivashchenko</small></div>
</footer>


</body>
</html>
