<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title></title>
    <link>http://www.sivaschenko.com</link>
    <description>
      Written with ♥ for developers
    </description>
    
        
            <item>
                <title>Magento 2. Retrieving category layered navigation filterable attributes</title>
                <link>http://www.sivaschenko.com/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/</link>
                <content:encoded>
                    <![CDATA[
                    <h1 id="introduction">Introduction</h1>

<p>Retrieving layered navigation attributes is a useful task that can be required during optimization and implementaion of various features.</p>

<p>As usual, there is more than one way for achieving the goal.</p>

<p>I will start from the most primitive and fast approach, and continue with more framework utilization recommended for future maintainability.</p>

<h1 id="sql-query">SQL Query</h1>

<p>Basically the raw sql query will clearly describe what I am going to achieve:</p>

<p>Variant 1 (subselects):</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
<span class="k">FROM</span> <span class="n">eav_attribute</span>
<span class="k">WHERE</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="k">IN</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
  <span class="k">FROM</span> <span class="n">catalog_eav_attribute</span>
  <span class="k">WHERE</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">is_filterable</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>
<span class="k">AND</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="k">IN</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
  <span class="k">FROM</span> <span class="n">eav_entity_attribute</span>
    <span class="k">JOIN</span> <span class="n">catalog_product_entity</span> <span class="k">ON</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_set_id</span> <span class="o">=</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">attribute_set_id</span>
    <span class="k">JOIN</span> <span class="n">catalog_category_product</span> <span class="k">ON</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">entity_id</span> <span class="o">=</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">product_id</span>
  <span class="k">WHERE</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="p">);</span>
</code></pre>
</div>

<p>Variant 2 (joins):</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span>
  <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
<span class="k">FROM</span> <span class="n">eav_attribute</span>
  <span class="k">JOIN</span> <span class="n">eav_entity_attribute</span> <span class="k">ON</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="o">=</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
  <span class="k">JOIN</span> <span class="n">catalog_eav_attribute</span> <span class="k">ON</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span> <span class="o">=</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span>
                             <span class="k">AND</span> <span class="n">catalog_eav_attribute</span><span class="p">.</span><span class="n">is_filterable</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">JOIN</span> <span class="n">catalog_product_entity</span> <span class="k">ON</span> <span class="n">eav_entity_attribute</span><span class="p">.</span><span class="n">attribute_set_id</span> <span class="o">=</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">attribute_set_id</span>
  <span class="k">JOIN</span> <span class="n">catalog_category_product</span> <span class="k">ON</span> <span class="n">catalog_product_entity</span><span class="p">.</span><span class="n">entity_id</span> <span class="o">=</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">product_id</span>
                                <span class="k">AND</span> <span class="n">catalog_category_product</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">eav_attribute</span><span class="p">.</span><span class="n">attribute_id</span><span class="p">;</span>
</code></pre>
</div>

<p>As you can see the attributes we need are <strong>filterable attributes from attribute sets of products included in specified category</strong>.</p>

<p>These sql queries will also help to test program realization later.</p>

<h1 id="using-resource">Using Resource</h1>

<p>Lets first try to perform the straight query using just a <code class="highlighter-rouge">ResourceConnection</code> (this approach can be used for prototyping or quick debug).</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$categoryId</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>

<span class="nv">$resource</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Framework\App\ResourceConnection</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$resource</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">();</span>

<span class="nv">$select</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">from</span><span class="p">([</span><span class="s1">'ea'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'eav_attribute'</span><span class="p">)],</span> <span class="s1">'ea.attribute_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'eea'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'eav_entity_attribute'</span><span class="p">)],</span> <span class="s1">'ea.attribute_id = eea.attribute_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'cea'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'catalog_eav_attribute'</span><span class="p">)],</span> <span class="s1">'ea.attribute_id = cea.attribute_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'cpe'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'catalog_product_entity'</span><span class="p">)],</span> <span class="s1">'eea.attribute_set_id = cpe.attribute_set_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">join</span><span class="p">([</span><span class="s1">'ccp'</span> <span class="o">=&gt;</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getTableName</span><span class="p">(</span><span class="s1">'catalog_category_product'</span><span class="p">)],</span> <span class="s1">'cpe.entity_id = ccp.product_id'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'cea.is_filterable = ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'ccp.category_id = ?'</span><span class="p">,</span> <span class="nv">$categoryId</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="s1">'ea.attribute_id'</span><span class="p">);</span>

<span class="nv">$attributeIds</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">fetchCol</span><span class="p">(</span><span class="nv">$select</span><span class="p">);</span>
</code></pre>
</div>

<p>Then attribute ids can be used to load collection of attributes.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$collectionFactory</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\ResourceModel\Product\Attribute\CollectionFactory</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$collection</span> <span class="o">=</span> <span class="nv">$collectionFactory</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">();</span>
<span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">setItemObjectClass</span><span class="p">(</span><span class="s1">'Magento\Catalog\Model\ResourceModel\Eav\Attribute'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">addStoreLabel</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">storeManager</span><span class="o">-&gt;</span><span class="na">getStore</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
<span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">addFieldToFilter</span><span class="p">(</span><span class="s1">'attribute_id'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'in'</span> <span class="o">=&gt;</span> <span class="nv">$attributeIds</span><span class="p">]);</span>
</code></pre>
</div>

<p>After this code is executed, <code class="highlighter-rouge">$attributeIds</code> is an array of filtable attribute ids involved in category with specified id.</p>

<p>However this implementation is not ideal, because it skips potentially extended behavior of layered navigation and small details like disabled, out of stock products, etc.</p>

<h1 id="using-layer">Using Layer</h1>

<p>After a bit of investigation I was not able to find framework api to provide filterable attributes for specific category.</p>

<p>So, the task is a bit more complex than seems to be.</p>

<p>Basically all filterable attributes in Magento 2 can be retrived from <strong>FilterableAttributeList</strong>:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$filterableAttributes</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Layer\Category\FilterableAttributeList</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$attributes</span> <span class="o">=</span> <span class="nv">$filterableAttributes</span><span class="o">-&gt;</span><span class="na">getList</span><span class="p">();</span>
</code></pre>
</div>

<p>Retrieving filters involved in layered navigation is a bit more tricky.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$filterableAttributes</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Layer\Category\FilterableAttributeList</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="nv">$appState</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Framework\App\State</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$layerResolver</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">\Magento\Catalog\Model\Layer\Resolver</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$filterList</span> <span class="o">=</span> <span class="nx">ObjectManager</span><span class="o">::</span><span class="na">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span>
    <span class="nx">\Magento\Catalog\Model\Layer\FilterList</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="s1">'filterableAttributes'</span> <span class="o">=&gt;</span> <span class="nv">$filterableAttributes</span>
    <span class="p">]</span>
<span class="p">);</span>

 <span class="nv">$category</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>
 
 <span class="nv">$appState</span><span class="o">-&gt;</span><span class="na">setAreaCode</span><span class="p">(</span><span class="s1">'frontend'</span><span class="p">);</span>
 <span class="nv">$layer</span> <span class="o">=</span> <span class="nv">$layerResolver</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
 <span class="nv">$layer</span><span class="o">-&gt;</span><span class="na">setCurrentCategory</span><span class="p">(</span><span class="nv">$category</span><span class="p">);</span>
 <span class="nv">$filters</span> <span class="o">=</span> <span class="nv">$filterList</span><span class="o">-&gt;</span><span class="na">getFilters</span><span class="p">(</span><span class="nv">$layer</span><span class="p">);</span>
</code></pre>
</div>

<p>Please be aware, that I am using object manager static calls just for short and explicit example. In clean implementation it is highly recommended to use di instead.</p>

<p>You might also want to use di configuration for defining <code class="highlighter-rouge">filterableAttributes</code> argument.</p>

<p>However this is not the final result. To be sure that filters are actual, it is required to check number of items for each filters. (that check is accually performed during core layered navigation <a href="//github.com/magento/magento2/blob/develop/app/code/Magento/LayeredNavigation/view/frontend/templates/layer/view.phtml#L38">rendering</a>)</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$filters</span> <span class="k">as</span> <span class="nv">$filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$filter</span><span class="o">-&gt;</span><span class="na">getItemsCount</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$filters</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$filter</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In above code block you can also perform additional checks and i.e. throw away Price and Category filter instances, if you need just Attribute type filters.</p>

<p>Then filter name and values can be retrieved:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="nv">$name</span> <span class="o">=</span> <span class="nv">$filter</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$filter</span><span class="o">-&gt;</span><span class="na">getItems</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Solutions mentioned here are the best I could find. However, they do not look perfect. So, if you know a better solution or at least can advise where to look, please leave a comment. I will much appreciate it!</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/magento2/2016/12/20/magento2-retrieving-category-layered-navigation-filterable-attributes/</guid>
                <description>
                    
                    Retrieving layered navigation attributes is a useful task that can be required during optimization and implementaion of various features ...
                    
                </description>
                <pubDate>Tue, 20 Dec 2016 08:20:29 +0000</pubDate>
                <author>Sergii Ivashchenko</author>
            </item>
        
    
        
            <item>
                <title>Apache running multiple PHP versions simultaneously</title>
                <link>http://www.sivaschenko.com/php/2016/11/22/apache-running-multiple-php-versions-simultaneously/</link>
                <content:encoded>
                    <![CDATA[
                    <h1 id="overview">Overview</h1>

<p>There are several ways to achieve the same goal and run multiple websites on different PHP versions simultaneously.</p>

<p>In my opinion, the most convenient way to install several PHP versions side-by-side for development purpose is using <strong>PHPBrew</strong>.</p>

<p>As for running multiple php versions on one server, my choice is <strong>Apache</strong> with <strong>FastCGI</strong>.</p>

<p>The approach described here includes the following steps:</p>

<ul>
  <li>Install several php versions using <strong>PHPBrew</strong></li>
  <li>Install <strong>Apache</strong> web server with <strong>FastCGI</strong> module</li>
  <li>Create separate <strong>FastCGI</strong> script for each php version</li>
  <li>Map appropriate <strong>FastCGI</strong> script for web application execution on <strong>virtual host level</strong></li>
</ul>

<p>The instructions are tested on <strong>ubuntu:xenial</strong> docker image (Ubuntu 16.04).</p>

<p>Tutorial is based on setting up enviroment from scratch, so some of steps can be skipped on particular environments, however there should be no problems to execute all mentioned commands even if some packages are already installed on the system.</p>

<div class="markdown-warning-note"><i class="fa fa-warning"></i>The installation and configuration demonstrated under <b>root</b> user for simplification. Please perform actions under appropriate user on your system where possible.</div>

<h1 id="installing-all-the-dependencies">Installing all the dependencies</h1>

<p>Adding <code class="highlighter-rouge">multiverse</code> and <code class="highlighter-rouge">partner</code> repositories to apt. These are required to fetch <code class="highlighter-rouge">libapache2-mod-fastcgi</code> package:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt update
apt install software-properties-common lsb-release
add-apt-repository "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) multiverse partner"
apt update
</code></pre>
</div>

<p>Than, we have to install MySQL, Apache and FastCGI module together with related dev packages as they will be required for PHP modules compilation:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt install apache2 apache2-dev libapache2-mod-fastcgi
apt install mysql-server mysql-client libmysqlclient-dev libmysqld-dev libpq-dev
</code></pre>
</div>

<p>Ensuring all other PHP dependecies are in place:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt install php php-dev php-pear autoconf automake curl libcurl3-openssl-dev build-essential libxslt1-dev re2c 
apt install libxml2 libxml2-dev php-cli bison libbz2-dev libreadline-dev libicu-dev libmcrypt-dev libmcrypt4
</code></pre>
</div>

<p>Installing PHPBrew:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -L -O https://github.com/phpbrew/phpbrew/raw/master/phpbrew
chmod +x phpbrew
mv phpbrew /usr/bin/phpbrew
phpbrew init
</code></pre>
</div>

<p>Now it is possible to install PHP 7 and 5 using PHPBrew. It will take some time.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>phpbrew install 5.6.28 +default +dbs +apxs2 +gd +iconv +intl +mcrypt +soap
phpbrew install 7.0.13 +default +dbs +apxs2 +gd +iconv +intl +mcrypt +soap
</code></pre>
</div>

<p>Check PHPBrew <a href="https://github.com/phpbrew/phpbrew">documentation</a> for further usage of various features provided by this tool.</p>

<h1 id="configuring-apache-fastcgi">Configuring apache fastcgi</h1>

<p>For editing files, you are free to use your preferred tool, or install my favourite <strong>vim</strong>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt install vim
</code></pre>
</div>

<p>Create a directory for FastCGI scripts:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir /var/www/cgi-bin
</code></pre>
</div>

<p>A FastCGI script should be created for each php version.</p>

<p>Lets save the script for PHP 7.0.13 to <code class="highlighter-rouge">/var/www/cgi-bin/php-7.0.13</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nv">PHPRC</span><span class="o">=</span><span class="s2">"/root/.phpbrew/php/php-7.0.13/etc/"</span>
<span class="nb">export </span>PHPRC

<span class="nv">PHP_FCGI_CHILDREN</span><span class="o">=</span>3
<span class="nb">export </span>PHP_FCGI_CHILDREN

<span class="nv">PHP_FCGI_MAX_REQUESTS</span><span class="o">=</span>5000
<span class="nb">export </span>PHP_FCGI_MAX_REQUESTS

<span class="nb">exec</span> /root/.phpbrew/php/php-7.0.13/bin/php-cgi
</code></pre>
</div>

<p>Corresponding script for PHP 5.6.28 to <code class="highlighter-rouge">/var/www/cgi-bin/php-5.6.28</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nv">PHPRC</span><span class="o">=</span><span class="s2">"/root/.phpbrew/php/php-5.6.28/etc/"</span>
<span class="nb">export </span>PHPRC

<span class="nv">PHP_FCGI_CHILDREN</span><span class="o">=</span>3
<span class="nb">export </span>PHP_FCGI_CHILDREN

<span class="nv">PHP_FCGI_MAX_REQUESTS</span><span class="o">=</span>5000
<span class="nb">export </span>PHP_FCGI_MAX_REQUESTS

<span class="nb">exec</span> /root/.phpbrew/php/php-5.6.28/bin/php-cgi
</code></pre>
</div>

<p>Give Apache permissions to execute created scripts:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>chmod -R +x /var/www/cgi-bin/
chown -R www-data /var/www/cgi-bin/
chmod +x /root/.phpbrew/php/php-5.6.28/bin/php-cgi
chmod +x /root/.phpbrew/php/php-7.0.13/bin/php-cgi
chown www-data /root/.phpbrew/php/php-5.6.28/bin/php-cgi
chown www-data /root/.phpbrew/php/php-7.0.13/bin/php-cgi
</code></pre>
</div>

<p>FastCGI configuration (<code class="highlighter-rouge">/etc/apache2/mods-available/fastcgi.conf</code>) should look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;IfModule mod_fastcgi.c&gt;
  AddHandler fastcgi-script .fcgi
  AddHandler php-cgi .php
  FastCgiServer /var/www/cgi-bin/php-5.6.28 -idle-timeout 3600
  FastCgiServer /var/www/cgi-bin/php-7.0.13 -idle-timeout 3600
  ScriptAlias /cgi-bin/ /var/www/cgi-bin/
&lt;/IfModule&gt;
</code></pre>
</div>

<p>Although ScriptAlias looks odd here, it is required for proper apache rewrites handling.</p>

<p><strong>-idle-timeout</strong> is not required, but recommended if you would like to use xdebug, for example, and do not want to get errors each time request is processing more than 30 seconds.</p>

<p>As FastCGI will now handle PHP files, we have to disable concurrent Apache PHP modules:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2dismod php5
a2dismod php7
</code></pre>
</div>

<h1 id="configuring-virtual-hosts">Configuring virtual hosts</h1>

<p>Creating basing websites:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir /var/www/php5
mkdir /var/www/php7
echo "&lt;?php phpinfo();" &gt; /var/www/php5/index.php
echo "&lt;?php phpinfo();" &gt; /var/www/php7/index.php
chown -R www-data /var/www
</code></pre>
</div>

<p>Create <strong>php5</strong> website virtual host configuration (<code class="highlighter-rouge">/etc/apache2/sites-available/php5.conf</code>):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;VirtualHost *:*&gt;
  ServerName php5.local.com
  DocumentRoot /var/www/php5
  Action php-cgi /cgi-bin/php-5.6.28
&lt;/VirtualHost&gt;
</code></pre>
</div>

<p>Create <strong>php7</strong> website virtual host configuration (<code class="highlighter-rouge">/etc/apache2/sites-available/php7.conf</code>):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;VirtualHost *:*&gt;
  ServerName php7.local.com
  DocumentRoot /var/www/php7
  Action php-cgi /cgi-bin/php-7.0.13
&lt;/VirtualHost&gt;
</code></pre>
</div>
<p>Enable Apache actions mod to be able to handle “Action” keyword:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2enmod actions
</code></pre>
</div>

<p>Enable created websites:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2ensite php5.conf
a2ensite php7.conf
service apache2 restart
</code></pre>
</div>

<p>For frameworks that are using apache rewrites, such as Magento for example you might want to add the next rewrite to virtual-host configuration or .htaccess file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>RewriteCond %{REQUEST_URI} ^/cgi-bin/php-(.*)
RewriteRule . - [L]
</code></pre>
</div>

<h1 id="testing-the-environment">Testing the environment</h1>

<p>Thats it! Now let’s test the created vebsites.</p>

<p>As we are using custom domains, these should be added to system hosts file (<code class="highlighter-rouge">/etc/hosts</code>):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>127.0.0.1   php5.local.com php7.local.com
</code></pre>
</div>

<p>Open your browser and visit php5.local.com and php7.local.com domains (or use wget).</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/php/2016/11/22/apache-running-multiple-php-versions-simultaneously/</guid>
                <description>
                    
                    Lets setup an Apache webserver to run PHP 5.6 and 7.0 websites simultaneously ...
                    
                </description>
                <pubDate>Tue, 22 Nov 2016 11:21:29 +0000</pubDate>
                <author>Sergii Ivashchenko</author>
            </item>
        
    
        
            <item>
                <title>Magento 2. Adding column to Sales Order grid</title>
                <link>http://www.sivaschenko.com/magento2/2016/03/05/magento2-add-column-to-sales-order-grid/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Sales order grid in Magento 2 can be accessed in admin panel under “Sales” -&gt; “Orders” menu.
By default only several main columns are visible in grid, but there are additional columns, that can be enabled from “Columns” dropdown on the top-right side.</p>

<p><img src="http://www.sivaschenko.com/images/magento2-sales-order-grid-columns.png" alt="Magento 2 Sales Order Grid Columns" /></p>

<p>However, if you are creating a module that provides additional useful information about orders, it is a good idea to add corresponding columns to sales order grid.</p>

<p>Basically, to add a column to sales order grid you have to perform 3 simple steps:</p>

<ul>
  <li>Add column to <strong>sales_order_grid</strong> database table</li>
  <li>Add DI configuration to populate the column in <strong>sales_order_grid</strong> table with your value</li>
  <li>Add UI component configuration to display the column in grid</li>
</ul>

<p>Let’s go through this implementation step by step.</p>

<h1 id="preconditions">Preconditions</h1>

<p>First of all, ensure you have your column in database table, and it is mapped to any field of <strong>sales_order</strong> table. For my example, let’s assume that there is <strong>affiliate</strong> table consisting of two columns: <strong>order_id</strong> and <strong>affiliate_information</strong>. This table is used to store some <a href="http://en.wikipedia.org/wiki/Affiliate_marketing">affiliate information</a> related to particular order. It would be nice to display this information in “Affiliate Information” column in sales order grid. Let’s do this!</p>

<h1 id="adding-column-to-salesordergrid-database-table">Adding column to sales_order_grid database table</h1>

<p>Columns are added to database tables using <strong>InstallSchema</strong> script. To be consistent, this script should be updated in the same module, where affiliate table was added.</p>

<p>The following code fragment will do the trick:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>$setup-&gt;getConnection()-&gt;addColumn(
    $setup-&gt;getTable('sales_order_grid'),
    'affiliate_information',
    [
        'type' =&gt; Table::TYPE_TEXT,
        'comment' =&gt; 'Affiliate Information'
    ]
);
</code></pre>
</div>

<p>Just add it to <code class="highlighter-rouge">app/code/&lt;your_namespace&gt;/&lt;your_module&gt;/Setup/InstallSchema.php</code> file and it will create a column named <strong>affiliate_information</strong>, of type text, with comment “Affiliate Information” to <strong>sales_order_grid</strong> during installation.</p>

<p>Don’t worry about implications of core table modification. <strong>sales_order_grid</strong> is index table and is used for order grid rendering speed up. It is designed to store all information required for sales order grid rendering, so custom columns are required to be added to this table.</p>

<p>To reflect changes in database magento reinstallation is required. Optionally, deleting module entry from setup_module table and running bin/magento setup:upgrade command will be also ok.</p>

<p>After this step, <strong>affiliate_information</strong> column is present in <strong>sales_order_grid</strong> table, but is remaining empty as it is not mapped to any data source.</p>

<h1 id="di-configuration-to-populate-the-column-is-salesordergrid-table">DI configuration to populate the column is sales_order_grid table.</h1>

<p>On this stage, it would be good to understand how <strong>sales_order_grid</strong> table is populated.</p>

<p>When order is placed (according to default configuration), data related to this order is selected from <strong>sales_order</strong> table joining several additional tables and inserted to <strong>sales_order_grid</strong>. This operation is initiated by <code class="highlighter-rouge">\Magento\Sales\Model\ResourceModel\Grid::refresh</code> function and the default select is declared in “&lt;Magento Sales module&gt;/etc/di.xml” file.</p>

<p>So to include our table in mentioned insert from select, we have to extend di configuration creating <code class="highlighter-rouge">app/code/&lt;Namespace&gt;/&lt;Module&gt;/etc/adminhtml/di.xml</code> file.</p>

<p>The following xml snippet should be added to di configuration inside config node.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;config</span> <span class="err">...</span><span class="nt">&gt;</span>
    ...
    <span class="nt">&lt;virtualType</span> <span class="na">name=</span><span class="s">"Magento\Sales\Model\ResourceModel\Order\Grid"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;arguments&gt;</span>
            <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"joins"</span> <span class="na">xsi:type=</span><span class="s">"array"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"affiliate"</span> <span class="na">xsi:type=</span><span class="s">"array"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"table"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>affiliate<span class="nt">&lt;/item&gt;</span>
                    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"origin_column"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>entity_id<span class="nt">&lt;/item&gt;</span>
                    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"target_column"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>order_id<span class="nt">&lt;/item&gt;</span>
                <span class="nt">&lt;/item&gt;</span>
            <span class="nt">&lt;/argument&gt;</span>
            <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"columns"</span> <span class="na">xsi:type=</span><span class="s">"array"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"affiliate_information"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>affiliate.affiliate_information<span class="nt">&lt;/item&gt;</span>
            <span class="nt">&lt;/argument&gt;</span>
        <span class="nt">&lt;/arguments&gt;</span>
    <span class="nt">&lt;/virtualType&gt;</span>
    ...
<span class="nt">&lt;/config&gt;</span>
</code></pre>
</div>

<p>This configuration is specifying that affiliate table will be joined to select from <strong>sales_order</strong> on <code class="highlighter-rouge">sales_order.entity_id = affiliate.order_id</code> and will populate <strong>sales_order_grid.affiliate_information</strong> column with corresponding value from <strong>affiliate.affiliate_information</strong>.</p>

<p>After this step, our affiliate_information column in <strong>sales_order_grid</strong> table is populated with value from affilate table each time order is placed. Still, column will exist only in database, and will not be visible in admin panel.</p>

<h1 id="configure-ui-grid-component-to-display-the-column">Configure UI grid component to display the column</h1>

<p>Finally, to reflect the column on admin panel grid, we have to extend <strong>sales_order_grid</strong> ui component by adding a ui configuration file in our module.</p>

<p>It is possible to extend ui configuration fo sales order grid introducing <code class="highlighter-rouge">app/code/&lt;Namespace&gt;/&lt;Module&gt;/view/adminhtml/ui_component/sales_order_grid.xml</code> file.
Basically it should have the same name and path in relation to module directory as main sales order grid ui component file: <code class="highlighter-rouge">app/code/Magento/Sales/view/adminhtml/ui_component/sales_order_grid.xml</code></p>

<p>Put the following xml snippet to the ui configuration file:</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;listing</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;columns</span> <span class="na">name=</span><span class="s">"sales_order_columns"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;column</span> <span class="na">name=</span><span class="s">"affiliate_information"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"data"</span> <span class="na">xsi:type=</span><span class="s">"array"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"config"</span> <span class="na">xsi:type=</span><span class="s">"array"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"filter"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>text<span class="nt">&lt;/item&gt;</span>
                    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">"label"</span> <span class="na">xsi:type=</span><span class="s">"string"</span> <span class="na">translate=</span><span class="s">"true"</span><span class="nt">&gt;</span>Affiliate Information<span class="nt">&lt;/item&gt;</span>
                <span class="nt">&lt;/item&gt;</span>
            <span class="nt">&lt;/argument&gt;</span>
        <span class="nt">&lt;/column&gt;</span>
    <span class="nt">&lt;/columns&gt;</span>
<span class="nt">&lt;/listing&gt;</span>
</code></pre>
</div>

<p>This will extend sales_order_columns and add a column based on <strong>affiliate_information</strong> filed, of type text, with translatable label “Affiliate Information”.</p>

<h1 id="ensuring-salesordergrid-is-populated-after-value-is-inserted-to-source-table">Ensuring sales_order_grid is populated after value is inserted to source table.</h1>

<p>There are two approaches to ensure that correct value is present in source table when <strong>sales_order_grid</strong> is populated:</p>

<ul>
  <li>Save value to source table before <strong>sales_order_grid</strong> refresh is triggered.</li>
  <li>Trigger <strong>sales_order_grid</strong> refresh after saving value.</li>
</ul>

<p>First approach is necessary if value should be saved to source table right on place order action. One of solutions will be to create observer on event that is dispatched when order is saved, but grid is still not refreshed. Such event is <code class="highlighter-rouge">sales_order_save_after</code>.</p>

<p>Second approach is applicable when source table is updated some time after order is placed, or asynchronously. Here you have to call <code class="highlighter-rouge">\Magento\Sales\Model\ResourceModel\Grid::refresh</code> method after value is saved to source table.</p>

<h1 id="populating-created-salesordergrid-column-for-existing-order">Populating created sales_order_grid column for existing order</h1>

<p>For upgrading existing data either install (for first release of your module) or upgrade script should be created.</p>

<p>Here is an example of upgrade script populating <code class="highlighter-rouge">sales_order_grid.affiliate_information</code> column from <code class="highlighter-rouge">affiliate.affiliate_information</code> for 1.0.1 version of module.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>namespace YourNamespace\YourModule\Setup;

use Magento\Framework\Setup\ModuleContextInterface;
use Magento\Framework\Setup\ModuleDataSetupInterface;
use Magento\Framework\Setup\UpgradeDataInterface;

class UpgradeData implements UpgradeDataInterface
{
    /**
     * {@inheritdoc}
     */
    public function upgrade(ModuleDataSetupInterface $setup, ModuleContextInterface $context)
    {
        $setup-&gt;startSetup();

        if (version_compare($context-&gt;getVersion(), '1.0.1', '<span class="err">&lt;</span>')) {
            $connection = $setup-&gt;getConnection();
            $grid = $setup-&gt;getTable('sales_order_grid');
            $affiliate = $setup-&gt;getTable('affiliate');

            $connection-&gt;query(
                $connection-&gt;updateFromSelect(
                    $connection-&gt;select()
                        -&gt;join(
                            $affiliate,
                            sprintf('%s.entity_id = %s.order_id', $grid, $affiliate),
                            'affiliate_information'
                        ),
                    $grid
                )
            );
        }

        $setup-&gt;endSetup();
    }
}
</code></pre>
</div>

<p>For this upgrade script to be executed, you have to increase module version in module.xml (from 1.0.0 to 1.0.1) and run <code class="highlighter-rouge">bin/magento setup:upgtade</code> command</p>

<h1 id="final-tips">Final Tips</h1>

<p>Be sure to refresh config cache after editing xml files.</p>

<p>Provided setting are basic, and there are much more parameters available for install script, di and ui configuration to customize content and appearance of added column, take time to observe existing install scripts, di and ui configuration files and try adding more parameters to your implementation.</p>

<p>Hope this tutorial was useful for you. Please feel free to provide any feedback in comments or contact me directly.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/magento2/2016/03/05/magento2-add-column-to-sales-order-grid/</guid>
                <description>
                    
                    First of all, ensure you have your column in database table, and it is mapped to any field of sales_order table...
                    
                </description>
                <pubDate>Sat, 05 Mar 2016 11:21:29 +0000</pubDate>
                <author>Sergii Ivashchenko</author>
            </item>
        
    
  </channel>
</rss>
