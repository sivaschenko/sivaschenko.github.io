<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Apache running multiple PHP versions simultaneously &#8211; sivaschenko</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Lets setup an Apache webserver to run PHP 5.6 and 7.0 websites simultaneously ...">
    <meta name="robots" content="all">
    <meta name="author" content="Sergii Ivashchenko">
    
    <meta name="keywords" content="magento2">
    <link rel="canonical" href="http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for sivaschenko" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css?201612122023" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <link rel="stylesheet" href="//cdn.rawgit.com/IonicaBizau/github-calendar/gh-pages/dist/github-calendar.css"/>

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Apache running multiple PHP versions simultaneously">
    <meta property="og:description" content="Written with ♥ for developers">
    <meta property="og:url" content="http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/">
    <meta property="og:site_name" content="sivaschenko">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@sergeivaschenko" />
    
    <meta name="twitter:title" content="Apache running multiple PHP versions simultaneously" />
    <meta name="twitter:description" content="Lets setup an Apache webserver to run PHP 5.6 and 7.0 websites simultaneously ..." />
    <meta name="twitter:url" content="http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/icons/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/icons/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/icons/favicon-32x32.png" sizes="32x32">

    
        <script type="text/javascript">
           (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
           (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
           })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
           ga('create', 'UA-33180732-4', 'auto');
           ga('send', 'pageview');
        </script>
    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://www.sivaschenko.com" class="site-title">sivaschenko</a>
      <nav class="site-nav">
        <a href="http://www.sivaschenko.com">Posts</a>

    
    

    
    
        <a href="/about/">About</a>
    

    
    

    
    

    
    

    
        <a href="/projects/">Projects</a>
    
    

    
    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-left">
    
      <a class="fa fa-github" href="https://github.com/sivaschenko"></a>
    
    
    
      <a class="fa fa-stack-overflow" href="https://stackoverflow.com/users/1518080"></a>
    
      <!--<a class="fa fa-rss" href="/feed.xml"></a>-->
    
      <a class="fa fa-twitter" href="https://twitter.com/sergeivaschenko"></a>
    
    
    
    
    
      <!--<a class="fa fa-envelope" href="mailto:contact@sivaschenko.com"></a>-->
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/sivashchenko"></a>
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1 class="page-title">Apache running multiple PHP versions simultaneously</h1>
  <span class="post-meta">Nov 22, 2016</span><br>
  
  <span class="post-meta small">
  
    3 minute read
  
  </span>
</div>

<article class="post-content">
  <h1 id="overview">Overview</h1>

<p>There are several ways to achieve the same goal and run multiple websites on different PHP versions simultaneously.</p>

<p>In my opinion, the most convenient way to install several PHP versions side-by-side for development purpose is using <a href="https://github.com/phpbrew/phpbrew">phpbrew</a>.
As for running multiple php versions on one server, my choice is Apache with fastcgi.</p>

<p>The approach described here in short includes the following steps:</p>

<ul>
  <li>Install several php versions using PHPBrew</li>
  <li>Install Apache web server with fastcgi module</li>
  <li>Create separate fastcgi script for each php version</li>
  <li>Specify fastcgi script for web application execution on virtual host level</li>
</ul>

<p>The instructions are tested on <strong>ubuntu:xenial</strong> docker image (Ubuntu 16.04).
Tutorial is based on setting up enviroment from scratch, so some of steps can be skipped on particular environments, however there should be no problems to execute all mentioned commands even if some packages are already installed on the system.</p>

<h1 id="installing-all-the-dependencies">Installing all the dependencies</h1>

<p>First lets add two additional repositories to apt that are required to fetch libapache2-mod-fastcgi package:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt update
apt install software-properties-common lsb-release
add-apt-repository "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) multiverse partner"
apt update
</code></pre>
</div>

<p>Than we have to install MySQL, Apache, Fastcgi mod with dev packages as they will be required for compiling php modules:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt install apache2 apache2-dev libapache2-mod-fastcgi
apt install mysql-server mysql-client libmysqlclient-dev libmysqld-dev libpq-dev
</code></pre>
</div>

<p>Ensuring all other php dependecies are in place:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt install php php-dev php-pear autoconf automake curl libcurl3-openssl-dev build-essential libxslt1-dev re2c 
apt install libxml2 libxml2-dev php-cli bison libbz2-dev libreadline-dev libicu-dev libmcrypt-dev libmcrypt4
</code></pre>
</div>

<p>Installing phpbrew:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -L -O https://github.com/phpbrew/phpbrew/raw/master/phpbrew
chmod +x phpbrew
mv phpbrew /usr/bin/phpbrew
phpbrew init
</code></pre>
</div>

<p>Now it is possible to install php 7 and 5 using phpbrew, it will take some time for compilation:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>phpbrew install 5.6.28 +default +dbs +apxs2 +gd +iconv +intl +mcrypt +soap
phpbrew install 7.0.13 +default +dbs +apxs2 +gd +iconv +intl +mcrypt +soap
</code></pre>
</div>

<p>Check phpbrew documentation for further usage of various features provided by this tool.</p>

<h1 id="configuring-apache-fastcgi">Configuring apache fastcgi</h1>

<p>For editing files, you are free to use your preferred tool, or install my favourite <strong>vi</strong>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt install vim
</code></pre>
</div>

<p>Create a directory for fastcgi scripts:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir /var/www/cgi-bin
</code></pre>
</div>

<p>A fastcgi script should be created for each php version.</p>

<p>Now a fastcgi script should be created for each php version.</p>

<p>Lets save script for PHP 7.0.13 as /var/www/cgi-bin/php-7.0.13</p>

<p>Here is an example content:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nv">PHPRC</span><span class="o">=</span><span class="s2">"/root/.phpbrew/php/php-7.0.13/etc/"</span>
<span class="nb">export </span>PHPRC

<span class="nv">PHP_FCGI_CHILDREN</span><span class="o">=</span>3
<span class="nb">export </span>PHP_FCGI_CHILDREN

<span class="nv">PHP_FCGI_MAX_REQUESTS</span><span class="o">=</span>5000
<span class="nb">export </span>PHP_FCGI_MAX_REQUESTS

<span class="nb">exec</span> /root/.phpbrew/php/php-7.0.13/bin/php-cgi
</code></pre>
</div>

<p>Script for PHP 5.6.28 should be saved as /var/www/cgi-bin/php-5.6.28</p>

<p>Here is an example content:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nv">PHPRC</span><span class="o">=</span><span class="s2">"/root/.phpbrew/php/php-5.6.28/etc/"</span>
<span class="nb">export </span>PHPRC

<span class="nv">PHP_FCGI_CHILDREN</span><span class="o">=</span>3
<span class="nb">export </span>PHP_FCGI_CHILDREN

<span class="nv">PHP_FCGI_MAX_REQUESTS</span><span class="o">=</span>5000
<span class="nb">export </span>PHP_FCGI_MAX_REQUESTS

<span class="nb">exec</span> /root/.phpbrew/php/php-5.6.28/bin/php-cgi
</code></pre>
</div>

<p>Give apache permissions to execute created scripts:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>chmod -R +x /var/www/cgi-bin/
chown -R www-data /var/www/cgi-bin/
chmod +x /root/.phpbrew/php/php-5.6.28/bin/php-cgi
chmod +x /root/.phpbrew/php/php-7.0.13/bin/php-cgi
chown www-data /root/.phpbrew/php/php-5.6.28/bin/php-cgi
chown www-data /root/.phpbrew/php/php-7.0.13/bin/php-cgi
</code></pre>
</div>

<p>Fastcgi configuration (<strong>/etc/apache2/mods-available/fastcgi.conf</strong>) should look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;IfModule mod_fastcgi.c&gt;
  AddHandler fastcgi-script .fcgi
  AddHandler php-cgi .php
  FastCgiServer /var/www/cgi-bin/php-5.6.28 -idle-timeout 3600
  FastCgiServer /var/www/cgi-bin/php-7.0.13 -idle-timeout 3600
  ScriptAlias /cgi-bin/ /var/www/cgi-bin/
&lt;/IfModule&gt;
</code></pre>
</div>

<p>Although ScriptAlias looks odd here, it is required for proper apache rewrites handling.
<strong>-idle-timeout</strong> is not required but recommended if you would like to use xdebug, for example, and do not want to get errors each time request is processing more than 30 seconds.</p>

<p>As fastcgi will now handle php files, we have to disable apache php modules:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2dismod php5
a2dismod php7
</code></pre>
</div>

<h1 id="configuring-virtual-hosts">Configuring virtual hosts</h1>

<p>Creating websites:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir /var/www/php5
mkdir /var/www/php7
echo "&lt;?php phpinfo();" &gt; /var/www/php5/index.php
echo "&lt;?php phpinfo();" &gt; /var/www/php7/index.php
chown -R www-data /var/www
</code></pre>
</div>

<p>Create <strong>php5</strong> website virtual host configuration (/etc/apache2/sites-available/php5.conf):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;VirtualHost *:*&gt;
  ServerName php5.local.com
  DocumentRoot /var/www/php5
  Action php-cgi /cgi-bin/php-5.6.28
&lt;/VirtualHost&gt;
</code></pre>
</div>

<p>Create <strong>php7</strong> website virtual host configuration (/etc/apache2/sites-available/php7.conf):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;VirtualHost *:*&gt;
  ServerName php7.local.com
  DocumentRoot /var/www/php7
  Action php-cgi /cgi-bin/php-7.0.13
&lt;/VirtualHost&gt;
</code></pre>
</div>
<p>Enable apache actions mod to be able to parse used “Action” keyword:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2enmod actions
</code></pre>
</div>

<p>Enable created websites:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2ensite php5.conf
a2ensite php7.conf
service apache2 restart
</code></pre>
</div>

<p>For frameworks that are using apache rewrites, such as Magento for example you might want to add the next rewrite to virtual-host configuration or .htaccess file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>RewriteCond %{REQUEST_URI} ^/cgi-bin/php-(.*)
RewriteRule . - [L]
</code></pre>
</div>

<p>Note: remember to add local domain names to hosts file before testing.</p>

</article>


  <div class="share-page">
  Share this post!

  <div class="share-links">
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Apache running multiple PHP versions simultaneously&url=http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/&title=Apache running multiple PHP versions simultaneously" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    

    

    
      <a class="fa fa-reddit" href="http://reddit.com/submit?url=http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/&title=Apache running multiple PHP versions simultaneously" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    

    
      <a class="fa fa-stumbleupon" href="http://www.stumbleupon.com/submit?url=http://www.sivaschenko.com/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously/&title=Apache running multiple PHP versions simultaneously" rel="nofollow" target="_blank" title="Share on StumbleUpon"></a>
    

    
  </div>
</div>




  <div class="post-footer">
  <img src="//gravatar.com/avatar/24b43157e5a79a15db64f3c1b2b1b988?s=180" alt="Sergii Ivashchenko" class="avatar" />
  <p>
    Written with ♥ for developers by Sergii Ivashchenko.
  </p>
  <p>
    Follow him on <a href="https://twitter.com/sergeivaschenko">Twitter</a>.
  </p>
</div>




  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'sivaschenko';
    var disqus_identifier = '/magento2/2016/11/22/apache-running-multiple-php-versions-simultaneously';
    var disqus_title      = "Apache running multiple PHP versions simultaneously";

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      &copy; <a href="//www.sivaschenko.com">Sergii Ivashchenko</a>
    </small>
  </div>
</footer>


</body>
</html>
